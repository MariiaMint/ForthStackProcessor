### Константинова Мария Александровна P3306
```
forth | stack | harv | hw | instr | struct | stream | mem | cstr | prob2
```
с упрощением

---
# Язык программирования 
## Описание синтаксиса 
Синтаксис языка основан на постфиксной нотации, где операнды следуют за операторами. Основные конструкции языка определяются в виде команд, которые могут быть вызваны и выполнять различные задачи (например, математические операции, ввод-вывод, ветвление, циклы). 
### Форма Бэкуса-Наура:
```ebnf
<программа> ::= <процедура>* <вызов>* 

<процедура> ::= : <идентификатор> ( <параметры> -- <возвращаемые значения> ) <операции> ;
<определение> ::= : <идентификатор> ( -- <возвращаемые значения> ) ;
<вызов> ::= <идентификатор> ;

<операции> ::= <выражение> | <условие> | <цикл> | <ввод> | <вывод> | <арифметическая операция>
<выражение> ::= <идентификатор> | <число> | <строка> | <арифметическая операция> ;
<условие> ::= IF <операции> ELSE <операции> FINISH ;
<цикл> ::= <параметр> DO <операции> LOOP ;
<ввод> ::= INPUT ;
<вывод> ::= ." <строка>" | .;
<вызов процедуры | определения> ::= <name> ";"

<арифметическая операция> ::= <выражение> <арифметический оператор> <выражение> ;
<арифметический оператор> ::= + | - | * | / ;
<сравнение> ::= "==" | ">" | "<"

<идентификатор> ::= <имя функции> ;
<число> ::= [0-9]+ ;
<строка> ::= " [символы] " ;
<строка для вывода> ::= "." <строка> ";"
<параметры> ::= <параметр>* ;
<параметр> ::= n | p | i ;
<возвращаемые значения> ::= <значение>* ;
<значение> ::= <число> | <строка> | <ввод> ;
```

### Стратегия вычислений,
- Код выполняется последовательно, одна инструкция за одной.
- Также же можно определять собственные процедуры:
	- Для этого нужно использовать ":" для начала определения процедуры;
	- Можно написать не влияющую на исполнение программы аннотацию - сигнатуры: (операнды -- возвращаемое значение);
	- Написать название процедуры как непрерывную последовательность символов;
	- Написать последовательность инструкций литералов и вызовов процедур для определения тела процедуры;
	- Использовать ";" для завершения определения процедуры.
- Процедуры используют встроенные инструкции или другие процедуры, поэтому также взаимодействуют со стеком.
- Использовать одну процедуру можно неограниченное количество раз.
#### Пример определения процедуры:

```
: PIGLETS ( n p -- ) 
n 3 == IF 
." поросёнка";
 ELSE ." не поросёнка"; FINISH ;


```
### Области видимости 
Переменные и определения команд имеют глобальную область видимости. Это означает, что определения, такие как `: b ( -- 5 ) ;`, могут быть вызваны в любой части программы после их определения. 
### Типизация и виды литералов 
- Числовые литералы: `: b ( -- 5 ) ;`
- Строковые литералы: строки : `s ( -- " supchik") ;`
- Вводимая строка: `: name ( -- INPUT) ;`
- Значение другого литерала: `: na ( -- n) ;`


# Организация памяти
- Модель памяти процессора: **гарвардская**
- Варианты адресации:
	- по адресу (прямая)
- Размер машинного слова:
	- не уточняется ввиду хранения команд в виде структур
```
	       Registers
+------------------------------+
| ACC                          |
| BUF                          | 
| PC                           |
| SR                           |
| IR                           |
+------------------------------+

       Instruction memory
+------------------------------+
| 0  : jmp N                  |
|    ...                       |
| 1  : interruption vector 0  |
| 2  : interruption vector 1  |
|    ...                       |
| n   : program start          |
|    ...                       |
+------------------------------+

          Data memory
+------------------------------+
| l+0 : num literals           |
| l+1 : num literals           |
|    ...                       |
| c+0 : variable 1             |
|    ...                       |
+------------------------------+

		Data Stack
+------------------------------+
| 00  : instruction 1          |
| 01  : instruction 2          |
| ..  : ...                    |
| 7F  : num l                  |
+------------------------------+

		Call Stack
+------------------------------+
| 00  : addr 1                 |
| 01  : addr 2                 |
+------------------------------+
```
- Машинное слово – не определено. Инструкции хранятся в высокоуровневой структуре данных.
- Размер операнда – не определен. Интерпретируется как знаковое целое число.
- Адресация – прямая, абсолютная, доступ к словам. Адрес берется с вершины стека. Косвенную адресацию можно реализовать программно.
- Программист не взаимодействует с адресами памяти данных на прямую. Транслятор сам решает, в каком месте выделить память под программу и под данные программы.
- Программа и данные хранятся в раздельной памяти согласно Гарвардской архитектуре. Процедуры размещаются в той же памяти, они обязаны завершаться при помощи инструкции RET.

Организация стека:

Стек реализован в виде высокоуровневой структуры данных (array)
В data-path стек - это 2 регистра:
acc - вершина стека- следующий за вершиной элемент (нужен для инструкций с двумя операндами )
stack[-1] 
Ячейка стека может уместить один операнд одной ячейки памяти.

# Система команд

Особенности процессора:

- Машинное слово – не определено.
- Тип данных - знаковые числа. Логические значения работаю как в C (0 - False, все остальное - True). 
- Доступ к памяти осуществляется по операнду команды
Обработка данных осуществляется в стеке. Данные попадают в стек из:
Памяти. Устройства ввода-вывода привязаны к ячейкам памяти.
С помощью инструкции PUSH.
АЛУ кладет результат вычислений на вершину стека.
Поток управления:
Значение PC инкриминируется после исполнения каждой инструкции;
Условный (JUMP_IF_FALSE) и безусловный (JUMP) переходы;



## Набор команд (Opcode)  
|  №  | instruction | opcode | addr / operand / port | update flags | description                                                                                       |  
|:---:|:-----------:|:------:|:---------------------:|:------------:|:--------------------------------------------------------------------------------------------------|  
| 1.  |    PUSH     | PUSH  |          yes          |      no      | Помещает значение в стек                                                                          |  
| 2.  |     POP     | POP   |          no           |      no      | Извлекает значение из стека                                                                       |  
| 3.  |     ADD     | ADD   |          no           |     yes      | Складывает два верхних значения на стеке и помещает результат на вершину стека                    |  
| 4.  |     SUB     | SUB   |          no           |     yes      | Вычитает верхнее значение на стеке из второго по счёту и помещает результат на вершину стека      |  
| 5.  |     MUL     | MUL   |          no           |     yes      | Умножает два верхних значения на стеке и помещает результат на вершину стека                      |  
| 6.  |     DIV     | DIV   |          no           |     yes      | Делит второе по счету значение на стеке на верхнее значение и помещает результат на вершину стека |  
| 7.  |     AND     | AND   |          no           |     yes      | Логическое И двух верхних значений на стеке, результат на вершину стека                           |  
| 8.  |     OR      | OR    |          no           |     yes      | Логическое ИЛИ двух верхних значений на стеке, результат на вершину стека 
| 10. |    LOAD     | LOAD  |          yes          |     yes      | Загрузка значения из памяти в стек                                                                |  
| 11. |  LOAD_TOP   | LOAD_TOP  |          no           |     yes      | Загрузка значения из памяти в стек. В качестве адреса используется верх стека                     |  
| 12. |    STORE    | STORE  |          yes          |      no      | Сохранение верхнего значения из стека в память                                                    |  
| 13. |  STORE_TOP  | STORE_TOP |          yes          |      no      | По адресу верха стека сохраняем в память второе сверху значение                                   |  
| 14. |     IN      | IN    |          no           |      no      | Ввод данных из устройства ввода в стек                                                            |  
| 15. |     OUT     | OUT   |          no           |      no      | Вывод верхнего значения из стека в устройство вывода                                              |  
| 16. |     JMP     | JUMP  |          yes          |      no      | Безусловный переход по адресу                                                                     |  
| 17. |     CMP     | CMP  |          no           |     yes      | Сравнивает два верхних значения на стеке, обновляет SR                                            |                                    |  
| 18. |     JGR    | JUMP_IF_GREATER  |          yes          |      no      | Переход, если результат сравнения больше или равен нулю                                           |  
| 19. |     JEQ     | JUMP_IF_EQUAL  |          yes          |      no      | Переход, если результат сравнения равен нулю |  
| 20. |     CALL     | CALL  |          yes          |      no      | Вызов функции |  
| 21. |     RET     | RET  |          no          |      no      | Возврат к основному коду |  


  
### Формат хранения инструкций

	[
	    {
	        "opcode": "IN"
	    },
	    {
	        "opcode": "DUP"
	    },
	    {
	        "opcode": "PUSH",
	        "operand": "0x0A"
	    }
	]

# Транслятор
Трансляция включает в себя:

- Разбиение текста программы на токены
- Удаление всех незначимых символов, считающихся комментариями
	- внутри скобок - сигнатуры функции
	- после / и до конца строки - комментарий
- Проверка формальной корректности программы
	- Правильность скобочной последовательности, только вместо скобок - парные операторы.
- Поиск переменных, выделение памяти под них, отчистка списка токенов от инициализации переменных
- Поиск функций
- Конвертацию токенов в наборы инструкций
- Составление из наборов инструкций кода
- Подставление адресов лэйблов в операнды инструкций

# Модель Control Unit
реализован в модуле ControlUnit.py
```
+------------------(+1)-----------------+
|                                       |
|   +-----+                             |
+-->|     |     +---------------+       |    +----------------+
    | MUX |---->| Program       |-------+--->| Instruction    |
+-->|     |     | Counter (PC)  |            | Memory         |
|   +-----+     +---------------+            +----------------+
|      ^                                     |
|      | sel_pc                              | Instruction (IR)
|      |                                     |
+----------------------------(sel_ir)--------+
       |                                     |      +------------+
       |                                     |      |  Buffer    |
       |                                     |  +---|  Register  |
       |                                     |  |   +------------+
       |                                     v  v        ^
       |                            +----------------+   |
       +----------------------------| Instruction    |---+
                                    |   Decoder      |
                                    |                |<---------+
                                    +----------------+          |
                                            |                   |
                                            | Control Signals   |
                                            v                   |
                                      +-------------+    Status |
                                      |             |-----------+
                                      |  Data Path  |
                   Input ------------>|             |------------> Output
                                      +-------------+
                                               ^
                                               |
                                       +----------------+
                                       |  Call Stack    |
                                       +----------------+

```
## Описание компонентов:
- Program Counter (PC): Регистр, хранящий адрес следующей команды для выполнения.
- MUX: Мультиплексор, выбирающий между увеличением PC на 1 или загрузкой нового адреса (например, для переходов и вызовов).
- Instruction Memory: Память, в которой хранятся инструкции программы.
- Instruction Register (IR): Регистр, содержащий текущую инструкцию, полученную из памяти.
- Instruction Decoder: Декодер инструкций, интерпретирует команду в IR и генерирует управляющие сигналы.
- Buffer Register (BR): Регистр-буфер, хранит операнд инструкции.
- Data Path: Путь данных, включает в себя АЛУ, стек, регистры и выполняет операции над данными.
- Status Register (SR): Регистр состояния, хранит флаги (например, ноль, отрицательное) от операций АЛУ.
- Call Stack: Стек вызовов, используется для хранения адресов возврата при вызове функций (CALL/RET).
- Input/Output: Интерфейсы для ввода данных и вывода результатов.
# Модель Datapath
```
                   +----------------+                 +------------+
input ------------>| Input Buffer    |                 | Output     |-----> output
                   +----------------+                 | Buffer     |
                           |                          +------------+
                           |                                |
                           v                                |
                   +----------------+                       |
                   |     Stack       |<---------------------+
                   +----------------+
                           |
                           v
                   +-----------------+
                   |     ALU         |
                   +-----------------+
                           |
                           v
                   +------------------+            +-------------+
                   |      TOS         |<---------->|  Flags (SR) | 
                   +------------------+            +-------------+
                           |
                           v
                 +---------------------+
                 |     MUX (addr sel)   |
                 +---------------------+
                           |
                           v
                 +---------------------+
                 | Data Memory          |
                 | (Read/Write)         |
                 +---------------------+
                           ^
                           |
                           +-----> Control Signals (store/load/top)
```
## Описание компонентов:
- Input Buffer: Хранит входные данные, которые могут быть загружены в стек через сигнал signal_in.
- Output Buffer: Сохраняет результаты вывода, полученные через сигнал signal_out.
- Stack: Стек данных для выполнения арифметических и логических операций.
- ALU (Арифметико-логическое устройство): Выполняет операции над двумя операндами и устанавливает флаги (например, N для отрицательного результата и Z для нулевого результата).
- Accumulator (acc): Регистратор, который хранит промежуточные результаты вычислений.
- Flags (SR): Флаги состояния от операций, такие как флаг нуля (Z) и отрицательного числа (N).
- MUX (Multiplexer): Используется для выбора адресов памяти (на основе управляющих сигналов).
- Data Memory: Память данных для чтения и записи, управляемая через сигналы signal_load, signal_store, signal_load_top и другие.
